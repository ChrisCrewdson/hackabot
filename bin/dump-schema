#!/usr/bin/env python

"""Dump the current DB schema"""

import os
import sys

if __name__ == "__main__":
    root = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
    sys.path.append("%s/lib/python" % root)

    from hackabot import conf, db, load_conf
    import MySQLdb

    load_conf(sys.argv[1])
    config = conf.find("database")
    assert config is not None

    hostname = config.get("hostname")
    database = config.get("database")
    username = config.get("username")
    password = config.get("password")

    conn = MySQLdb.connect(host=hostname, db=database,
            user=username, passwd=password)
    version = db.current_schema(conn)
    conn.close()

    dump = open("%s/schema-%03d.sql" % (conf.get('mysql'), version), 'w')
    print "Dumping %s to %s" % (database, dump.name)
    os.dup2(dump.fileno(), 1)
    dump.close()
    os.execvp("mysqldump", ("mysqldump", "--no-data",
        "--skip-add-drop-table", "--host=%s" % hostname,
        "--user=%s" % username, "--password=%s" % password, database))
